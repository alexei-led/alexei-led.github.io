<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Network emulation for Docker containers | Terra Nullius</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Network emulation for Docker containers" />
<meta name="author" content="Alexei Lednev" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="TL;DR" />
<meta property="og:description" content="TL;DR" />
<link rel="canonical" href="http://localhost:4000/development/2016/08/01/pumba-docker-netem.html" />
<meta property="og:url" content="http://localhost:4000/development/2016/08/01/pumba-docker-netem.html" />
<meta property="og:site_name" content="Terra Nullius" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-08-01T21:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Network emulation for Docker containers" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alexei Lednev"},"dateModified":"2016-08-01T21:00:00+03:00","datePublished":"2016-08-01T21:00:00+03:00","description":"TL;DR","headline":"Network emulation for Docker containers","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/development/2016/08/01/pumba-docker-netem.html"},"url":"http://localhost:4000/development/2016/08/01/pumba-docker-netem.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Terra Nullius" />
<!-- Custom head content -->

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Additional custom styles -->
<style>
  body {
    font-family: 'Roboto', sans-serif;
  }
  .site-title {
    font-weight: 700;
  }
  .post-content img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
  }
  pre, code {
    border-radius: 4px;
  }
  .post-tag {
    display: inline-block;
    background-color: #f0f0f0;
    padding: 2px 8px;
    border-radius: 3px;
    margin-right: 5px;
    font-size: 0.8em;
  }
</style>

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
</head>
<body><header class="site-header">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Terra Nullius</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/">Alexei Lednev&#39;s Blog</a></div>
      </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Network emulation for Docker containers</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-08-01T21:00:00+03:00" itemprop="datePublished">Aug 1, 2016
      </time></p>
      
    
    <div class="post-tags">
      <strong>Tags:</strong>
      
        <span class="post-tag">Docker</span>
      
        <span class="post-tag">testing</span>
      
        <span class="post-tag">chaos testing</span>
      
        <span class="post-tag">netem</span>
      
        <span class="post-tag">network</span>
      
    </div>
    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="tldr">TL;DR</h2>
<blockquote>
<p><a href="https://github.com/gaia-adm/pumba">Pumba</a> <code>netem delay</code> and <code>netem loss</code> commands can emulate network <em>delay</em> and <em>packet loss</em> between Docker containers, even on single host. Give it a try!</p>
</blockquote>
<h2 id="introduction">Introduction</h2>
<p>Microservice architecture has been adopted by software teams as a way to deliver business value faster. Container technology enables delivery of microservices into any environment. Docker has accelerated this by providing an easy to use toolset for development teams to build, ship, and run distributed applications. These applications can be composed of hundreds of microservices packaged in Docker containers.</p>
<p>In a recent NGINX <a href="https://www.nginx.com/resources/library/app-dev-survey/">survey</a> [Finding #7], the “biggest challenge holding back developers” is the trade-off between quality and speed. As Martin Fowler indicates, <a href="http://martinfowler.com/articles/microservice-testing">testing strategies in microservices architecture</a> can be very complex. Creating a realistic and useful testing environment is an aspect of this complexity.</p>
<p>One challenge is <strong>simulating network failures</strong> to ensure <strong>resiliency</strong> of applications and services.</p>
<p>The network is a critical arterial system for ensuring reliability for any distributed application. Network conditions are different depending on where the application is accessed. Network behavior can greatly impact the overall application availability, stability, performance, and user experience (UX). It’s critical to simulate and understand these impacts before the user notices. Testing for these conditions requires conducting realistic network tests.</p>
<p>After Docker containers are deployed in a cluster, all communication between containers happen over the network. These containers run on a single host, different hosts, different networks, and in different datacenters.</p>
<blockquote>
<p>How can we test for the impact of network behavior on the application? What can we do to emulate different network properties between containers on a single host or among clusters on multiple hosts?</p>
</blockquote>
<h2 id="pumba-with-network-emulation">Pumba with Network Emulation</h2>
<p><a href="https://github.com/gaia-adm/pumba">Pumba</a> is a chaos testing tool for Docker containers, inspired by <a href="https://github.com/Netflix/SimianArmy/wiki/Chaos-Monkey">Netflix Chaos Monkey</a>. The main benefit is that it works with containers instead of VMs. Pumba can kill, stop, restart running Docker containers or pause processes within specified containers. We use it for resilience testing of our distributed applications. Resilience testing ensures reliability of the system. It allows the team to verify their application recovers correctly regardless of any event (expected or unexpected) without any loss of data or functionality. Pumba simulates these events for distributed and containerized applications.</p>
<h3 id="pumba-codenetemcode">Pumba <code>netem</code></h3>
<p>We enhanced <a href="https://github.com/gaia-adm/pumba">Pumba</a> with network emulation capabilities starting with <em>delay</em> and <em>packet loss</em>. Using <code>pumba netem</code> command we can apply <em>delay</em> or <em>packet loss</em> on any Docker container. Under the hood, <strong>Pumba</strong> uses Linux kernel traffic control (<a href="http://man7.org/linux/man-pages/man8/tc.8.html">tc</a>) with <a href="http://man7.org/linux/man-pages/man8/tc-netem.8.html">netem</a> queueing discipline. To work, we need to add <a href="https://wiki.linuxfoundation.org/networking/iproute2">iproute2</a> to Docker images, that we want to test. Some base Docker images already include <a href="https://wiki.linuxfoundation.org/networking/iproute2">iproute2</a> package.</p>
<p>Pumba <code>netem delay</code> and <code>netem loss</code> commands can emulate network <em>delay</em> and <em>packet loss</em> between Docker containers, even on a single host.</p>
<p>Linux has a built-in network emulation capabilities, starting from kernel 2.6.7 (released 14 years ago). Linux allows us to manipulate traffic control settings, using <a href="http://man7.org/linux/man-pages/man8/tc.8.html">tc</a> tool, available in <a href="https://wiki.linuxfoundation.org/networking/iproute2">iproute2</a>; <a href="http://man7.org/linux/man-pages/man8/tc-netem.8.html">netem</a> is an extension (<em>queueing discipline</em>) of the tc tool. It allows emulation of network properties — <em>delay</em>, <em>packet loss</em>, <em>packer reorder</em>, <em>duplication</em>, <em>corruption</em>, and <em>bandwidth rate</em>.</p>
<p><strong>Pumba</strong> <code>netem</code> commands can help development teams simulate realistic network conditions as they build, ship, and run microservices in Docker containers.</p>
<p><strong>Pumba</strong> with low level <code>netem</code> options, greatly simplifies its usage. We have made it easier to emulate different network properties for running Docker containers.</p>
<p>In the current release, <strong>Pumba</strong> modifies <em>egress</em> traffic only by adding <em>delay</em> or <em>packet loss</em> for specified container(s). Target containers can be specified by name (single name or as a space separated list) or via regular expression (<a href="https://github.com/google/re2/wiki/Syntax">RE2</a>). <strong>Pumba</strong> modifies container network conditions for a specified duration. After a set time interval, <strong>Pumba</strong> restores normal network conditions. <strong>Pumba</strong> also restores the original connection with a graceful shutdown of the <code>pumba</code> process <code>Ctrl-C</code> or by stopping the <strong>Pumba</strong> container with <code>docker stop</code> command.
An option is available to apply an IP range filter to the network emulation. With this option, <strong>Pumba</strong> will modify outgoing traffic for specified IP and will leave other outgoing traffic unchanged. Using this option, we can change network properties for a specific inter-container connection(s) as well as specific Docker networks — each Docker network has its own IP range.</p>
<h3 id="pumba-delay-codenetem-delaycode">Pumba delay: <code>netem delay</code></h3>
<p>To demonstrate, we’ll run two Docker containers: one is running a <code>ping</code> command and the other is <strong>Pumba</strong> Docker container, that adds 3 seconds network <em>delay</em> to the ping container for 1 minute. After 1 minute, <strong>Pumba</strong> container restores the network connection properties of the ping container as it exits gracefully.</p>
<p><a href="https://asciinema.org/a/82428?t=7"><img src="https://asciinema.org/a/82428.png" width=800></a></p>
<pre><code># open two terminal windows: (1) and (2)

# terminal (1)
# create new 'tryme' Alpine container (with iproute2) and ping `www.example.com`
$ docker run -it --rm --name tryme alpine sh -c &quot;apk add --update iproute2 &amp;&amp; ping www.example.com&quot;

# terminal (2)
# run pumba: add 3s delay to `tryme` container for 1m
$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
         pumba netem --interface eth0 --duration 1m delay --time 3000 tryme

# See `ping` delay increased by 3000ms for 1 minute
# You can stop Pumba earlier with `Ctrl-C`
</code></pre>
<h3 id="codenetem-delaycode-examples"><code>netem delay</code> examples</h3>
<p>This section contains more advanced network emulation examples for <code>delay</code> command.</p>
<pre><code># add 3 seconds delay for all outgoing packets on device `eth0` (default) of `mydb` Docker container for 5 minutes

$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
    pumba netem --duration 5m \
      delay --time 3000 \
      mydb
</code></pre><pre><code># add a delay of 3000ms ± 30ms, with the next random element depending 20% on the last one,
# for all outgoing packets on device `eth1` of all Docker container, with name start with `hp`
# for 10 minutes

$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
    pumba netem --duration 5m --interface eth1 \
      delay \
        --time 3000 \
        --jitter 30 \
        --correlation 20 \
      re2:^hp
</code></pre><pre><code># add a delay of 3000ms ± 40ms, where variation in delay is described by `normal` distribution,
# for all outgoing packets on device `eth0` of randomly chosen Docker container from the list
# for 10 minutes

$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
    pumba --random \
      netem --duration 5m \
        delay \
          --time 3000 \
          --jitter 40 \
          --distribution normal \
        container1 container2 container3
</code></pre>
<h2 id="pumba-packet-loss-codenetem-losscode-codenetem-loss-statecode-codenetem-loss-gemodelcode">Pumba packet loss: <code>netem loss</code>, <code>netem loss-state</code>, <code>netem loss-gemodel</code></h2>
<p>Lets start with <em>packet loss</em> demo. Here we will run three Docker containers. <code>iperf</code> <strong>server</strong> and <strong>client</strong> for sending data and Pumba Docker container, that will add packer loss on client container.
We are using <strong>perform network throughput tests</strong> tool <a href="http://manpages.ubuntu.com/manpages/xenial/man1/iperf.1.html">iperf</a> to demonstrate <em>packet loss</em>.</p>
<p><a href="https://asciinema.org/a/82430"><img src="https://asciinema.org/a/82430.png" width=800></a></p>
<pre><code># open three terminal windows

# terminal (1) iperf server
# server: `-s` run in server mode; `-u` use UDP;  `-i 1` report every second
$ docker run -it --rm --name tryme-srv alpine sh -c &quot;apk add --update iperf &amp;&amp; iperf -s -u -i 1&quot;

# terminal (2) iperf client
# client: `-c` client connects to &lt;server ip&gt;; `-u` use UDP
$ docker run -it --rm --name tryme alpine sh -c &quot;apk add --update iproute2 iperf &amp;&amp; iperf -c 172.17.0.3 -u&quot;

# terminal (3)
# run pumba: add 20% packet loss to `tryme` container for 1m
$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
         pumba netem --duration 1m loss --percent 20 tryme

# See server report on terminal (1) 'Lost/Total Datagrams' - should see lost packets there
</code></pre>
<p>It is generally understood that <em>packet loss</em> distribution in IP networks is “bursty”. To simulate more realistic <em>packet loss</em> events, different probability models are used.
Pumba currently supports 3 different loss probability models for *packet loss&quot;. Pumba defines separate <em>loss</em> command for each probability model.</p>
<ul>
<li><code>loss</code> - independent probability loss model (Bernoulli model); it's the most widely used loss model where packet losses are modeled by a random process consisting of Bernoulli trails</li>
<li><code>loss-state</code> - 2-state, 3-state and 4-state State Markov models</li>
<li><code>loss-gemodel</code> - Gilbert and Gilbert-Elliott models</li>
</ul>
<p>Papers on network packer loss models:</p>
<ul>
<li>&quot;Indepth: Packet Loss Burstiness&quot; <a href="http://www.voiptroubleshooter.com/indepth/burstloss.html">link</a></li>
<li>&quot;Definition of a general and intuitive loss model for packet networks and its implementation in the Netem module in the Linux kernel.&quot; <a href="netgroup.uniroma2.it/TR/TR-loss-netem.pdf">link</a></li>
<li><code>man netem</code> <a href="http://man7.org/linux/man-pages/man8/tc-netem.8.html">link</a></li>
</ul>
<h3 id="codenetem-losscode-examples"><code>netem loss</code> examples</h3>
<pre><code># loss 0.3% of packets
# apply for `eth0` network interface (default) of `mydb` Docker container for 5 minutes

$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
    pumba netem --duration 5m \
      loss --percent 0.3 \
      mydb
</code></pre><pre><code># loss 1.4% of packets (14 packets from 1000 will be lost)
# each successive probability (of loss) depends by a quarter on the last one
#   Prob(n) = .25 * Prob(n-1) + .75 * Random
# apply on `eth1` network interface  of Docker containers (name start with `hp`) for 15 minutes

$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
    pumba netem --interface eth1 --duration 15m \
      loss --percent 1.4 --correlation 25 \
      re2:^hp
</code></pre><pre><code># use 2-state Markov model for packet loss probability: P13=15%, P31=85%
# apply on `eth1` network interface of 3 Docker containers (c1, c2 and c3) for 12 minutes

$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
    pumba netem --interface eth1 --duration 12m \
      loss-state -p13 15 -p31 85 \
      c1 c2 c3
</code></pre><pre><code># use Gilbert-Elliot model for packet loss probability: p=5%, r=90%, (1-h)=85%, (1-k)=7%
# apply on `eth2` network interface of `mydb` Docker container for 9 minutes and 30 seconds

$ docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock gaiaadm/pumba \
    pumba netem --interface eth2 --duration 9m30s \
      loss-gemodel --pg 5 --pb 90 --one-h 85 --one-k 7 \
      mydb
</code></pre>
<h2 id="contribution">Contribution</h2>
<p>Special thanks to <a href="https://medium.com/@GehaniNeil">Neil Gehani</a> for helping me with this post and to <a href="https://github.com/inbarshani">Inbar Shani</a> for initial Pull Request with <code>netem</code> command.</p>
<h2 id="next">Next</h2>
<p>To see more examples on how to use Pumba with [netem] commands, please refer to the <a href="https://github.com/gaia-adm/pumba">Pumba GitHub Repository</a>. We have open sourced it. We gladly accept ideas, pull requests, issues, or any other contributions.</p>
<p>Pumba can be downloaded as precompiled binary (Windows, Linux and MacOS) from the <a href="https://github.com/gaia-adm/pumba/releases">GitHub project release page</a>. It’s also available as a <a href="https://hub.docker.com/r/gaiaadm/pumba/">Docker image</a>.</p>
<p><a href="https://github.com/gaia-adm/pumba">Pumba GitHub Repository</a></p>

  </div><a class="u-url" href="/development/2016/08/01/pumba-docker-netem.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Alexei Lednev</li><li><a class="u-email" href="mailto:alexei.led@gmail.com">alexei.led@gmail.com</a></li></ul>
      </div>

      <div class="footer-col">
        <p>Alexei Lednev&#39;s personal blog</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
      <a href="https://github.com/alexei-led" title="GitHub">
        <svg class="svg-icon grey">
          <use xlink:href="/assets/minima-social-icons.svg#github"></use>
        </svg>
        <span class="username">Github</span>
      </a>
    </li></ul></div>
  </div>
</footer></body>

</html>
