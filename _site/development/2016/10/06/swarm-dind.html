<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Docker Swarm cluster with docker-in-docker on MacOS | Terra Nullius</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Docker Swarm cluster with docker-in-docker on MacOS" />
<meta name="author" content="Alexei Lednev" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Docker-in-Docker dind can help you to run Docker Swarm cluster on your Macbook only with Docker for Mac (v1.12+). No virtualbox, docker-machine, vagrant or other app is required." />
<meta property="og:description" content="Docker-in-Docker dind can help you to run Docker Swarm cluster on your Macbook only with Docker for Mac (v1.12+). No virtualbox, docker-machine, vagrant or other app is required." />
<link rel="canonical" href="http://localhost:4000/development/2016/10/06/swarm-dind.html" />
<meta property="og:url" content="http://localhost:4000/development/2016/10/06/swarm-dind.html" />
<meta property="og:site_name" content="Terra Nullius" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-10-06T17:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Docker Swarm cluster with docker-in-docker on MacOS" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alexei Lednev"},"dateModified":"2016-10-06T17:00:00+03:00","datePublished":"2016-10-06T17:00:00+03:00","description":"Docker-in-Docker dind can help you to run Docker Swarm cluster on your Macbook only with Docker for Mac (v1.12+). No virtualbox, docker-machine, vagrant or other app is required.","headline":"Docker Swarm cluster with docker-in-docker on MacOS","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/development/2016/10/06/swarm-dind.html"},"url":"http://localhost:4000/development/2016/10/06/swarm-dind.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Terra Nullius" />
<!-- Custom head content -->

<!-- Basic styles for images and videos -->
<style>
  .post-content img {
    max-width: 100%;
    height: auto;
  }
  
  .video-container {
    position: relative;
    padding-bottom: 56.25%;
    padding-top: 30px; 
    height: 0; 
    overflow: hidden;
    margin-bottom: 20px;
  }
  
  .video-container iframe,
  .video-container object,
  .video-container embed {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body><header class="site-header">
  <div class="wrapper"><a class="site-title" rel="author" href="/%20/">Terra Nullius</a><nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/">Posts</a></div>
    </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Docker Swarm cluster with docker-in-docker on MacOS</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-10-06T17:00:00+03:00" itemprop="datePublished">Oct 6, 2016
      </time></p>
      
    
    <div class="post-tags">
      <strong>Tags:</strong>
      
        <span class="post-tag">Docker</span>
      
        <span class="post-tag">Swarm</span>
      
        <span class="post-tag">MasOS</span>
      
        <span class="post-tag">1.12</span>
      
    </div>
    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <blockquote>
<p>Docker-in-Docker <a href="https://hub.docker.com/_/docker/">dind</a> can help you to run Docker Swarm cluster on your Macbook only with Docker for Mac (v1.12+). No <code>virtualbox</code>, <code>docker-machine</code>, <code>vagrant</code> or other app is required.</p>
</blockquote>
<h2 id="the-beginning">The Beginning</h2>
<p>One day, I've decided to try running Docker 1.12 Swarm cluster on my MacBook Pro. Docker team did a great job releasing Docker for Mac, and from that time I forgot all problems I used to have with <code>boot2docker</code>. I really like Docker for Mac: it’s fast, lightweight, tightly integrated with MacOS and significantly simplifies my life when working in changing network environment. The only missing thing is that it's possible to create and work with single Docker daemon running inside <code>xhyve</code> VM. Shit! I want a cluster.</p>
<p>Of cause, it's possible to create Swarm cluster with <code>docker-machine</code> tool, but it's not MacOS friendly and requires to install additional VM software, like VirtualBox or Parallels (why? I already have <code>xhyve</code>!). I have different network for work office and home. At work I'm behind corporate proxy with multiple firewall filters. At home, of cause, life is better. <code>docker-machine</code> requires to create dedicated VMs for each environment and thus force me juggling with different shell scripts when I switch from one to another. It's possible, but it's not fun.</p>
<blockquote>
<p>I just want to have multi-node Swarm cluster with Docker for Mac (and <code>xhyve</code> VM). As simple as it is.</p>
</blockquote>
<p>I’m a lazy person and if there is an already existing solution, I will alway choose one, even if it’s not ideal. So, after googling for a while, I've failed to find any suitable solution or blog post. So, I’ve decided to create my own and share it with you.</p>
<h2 id="the-idea">The Idea</h2>
<p>The basic idea is to use Docker for Mac for running Swam master and several <a href="https://hub.docker.com/_/docker/">Docker-in-Docker containers</a> for running Swarm worker nodes.</p>
<p>First, lets init our Swarm master:</p>
<pre><code># init Swarm master
docker swarm init
</code></pre>
<p>... keep Swarm join token:</p>
<pre><code># get join token
SWARM_TOKEN=$(docker swarm join-token -q worker)
</code></pre>
<p>... and Docker <code>xhyve</code> VM IP:</p>
<pre><code># get Swarm master IP (Docker for Mac xhyve VM IP)
SWARM_MASTER=$(docker info | grep -w 'Node Address' | awk '{print $3}')
</code></pre>
<p>... now let's create 3 worker nodes and join these nodes to our cluster</p>
<pre><code># run NUM_WORKERS workers with SWARM_TOKEN
NUM_WORKERS=3
for i in $(seq “${NUM_WORKERS}&quot;); do
  docker run -d --privileged --name worker-${i} --hostname=worker-${i} -p ${i}2375:2375 docker:1.12.1-dind
  docker --host=localhost:${i}2375 swarm join --token ${SWARM_TOKEN} ${SWARM_MASTER}:2377
done
</code></pre>
<p>Listing all our Swarm cluster nodes:</p>
<pre><code># list Swarm nodes :)
docker node ls
</code></pre>
<p>... you should see something like this:</p>
<pre><code>ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS
1f6z8pioh3vuaz84gyp0biqt0    worker-2  Ready   Active
35z72o6zjhs9u1h99lrwzvx5n    worker-3  Ready   Active
d9ph5cmc604wp1vhhs754nnxx *  moby      Ready   Active        Leader
dj3gnpv86uqrw4b9mo9ux4jb5    worker-1  Ready   Active
</code></pre>
<p>That's all folks! Now, you have running Swarm cluster on your Macbook and your Docker client is talking with Swarm master.</p>
<h3 id="nice-tip">Nice tip:</h3>
<p>You can use very nice [Swarm visualizer] (<a href="https://github.com/ManoMarks/docker-swarm-visualizer">https://github.com/ManoMarks/docker-swarm-visualizer</a>) by Mano Marks to see your Swarm cluster &quot;in action&quot;.</p>
<p>Run it with following command:</p>
<pre><code>docker run -it -d -p 8000:8000 -e HOST=localhost -e PORT=8000 -v /var/run/docker.sock:/var/run/docker.sock manomarks/visualizer
</code></pre>
<p>And you should be able to see something like this (after you deploy some demo app):</p>
<p><img src="/assets/images/docker_visualizer.png" alt="Docker Swarm visualizer: Voting App" /></p>

  </div><a class="u-url" href="/development/2016/10/06/swarm-dind.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Alexei Lednev</li><li><a class="u-email" href="mailto:alexei.led@gmail.com">alexei.led@gmail.com</a></li></ul>
      </div>

      <div class="footer-col">
        <p>Alexei Ledenev&#39;s blog</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
      <a href="https://github.com/alexei-led" title="GitHub">
        <svg class="svg-icon grey">
          <use xlink:href="/assets/minima-social-icons.svg#github"></use>
        </svg>
        <span class="username">Github</span>
      </a>
    </li></ul></div>
  </div>
</footer></body>

</html>
