<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Create lean Node.js image with Docker multi-stage build | Terra Nullius</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Create lean Node.js image with Docker multi-stage build" />
<meta name="author" content="Alexei Lednev" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="TL;DR" />
<meta property="og:description" content="TL;DR" />
<link rel="canonical" href="http://localhost:4000/docker/2017/04/25/node-docker-multistage.html" />
<meta property="og:url" content="http://localhost:4000/docker/2017/04/25/node-docker-multistage.html" />
<meta property="og:site_name" content="Terra Nullius" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-04-25T19:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Create lean Node.js image with Docker multi-stage build" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alexei Lednev"},"dateModified":"2017-04-25T19:00:00+03:00","datePublished":"2017-04-25T19:00:00+03:00","description":"TL;DR","headline":"Create lean Node.js image with Docker multi-stage build","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/docker/2017/04/25/node-docker-multistage.html"},"url":"http://localhost:4000/docker/2017/04/25/node-docker-multistage.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Terra Nullius" />
<!-- Custom head content -->

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Additional custom styles -->
<style>
  body {
    font-family: 'Roboto', sans-serif;
  }
  .site-title {
    font-weight: 700;
  }
  .post-content img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
  }
  pre, code {
    border-radius: 4px;
  }
  .post-tag {
    display: inline-block;
    background-color: #f0f0f0;
    padding: 2px 8px;
    border-radius: 3px;
    margin-right: 5px;
    font-size: 0.8em;
  }
</style>

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
</head>
<body><header class="site-header">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Terra Nullius</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/">Alexei Lednev&#39;s Blog</a></div>
      </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Create lean Node.js image with Docker multi-stage build</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-04-25T19:00:00+03:00" itemprop="datePublished">Apr 25, 2017
      </time></p>
      
    
    <div class="post-tags">
      <strong>Tags:</strong>
      
        <span class="post-tag">docker</span>
      
        <span class="post-tag">tutorial</span>
      
        <span class="post-tag">devops</span>
      
        <span class="post-tag">hacks</span>
      
        <span class="post-tag">node</span>
      
        <span class="post-tag">node.js</span>
      
        <span class="post-tag">multistage</span>
      
        <span class="post-tag">Dockerfile</span>
      
    </div>
    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="tldr">TL;DR</h2>
<p>Starting from Docker 17.05+, you can create a single <code>Dockerfile</code> that can build multiple helper images with compilers, tools, and tests and use files from above images to produce the <strong>final</strong> Docker image.</p>
<p><img src="/assets/images/multi_stage_build.png" alt="Multi-stage Docker Build" /></p>
<h2 id="the-quotcore-principlequot-of-dockerfile">The &quot;core principle&quot; of Dockerfile</h2>
<p>Docker can build images by reading the instructions from a <code>Dockerfile</code>. A <code>Dockerfile</code> is a text file that contains a list of all the commands needed to build a new Docker image. The syntax of <code>Dockerfile</code> is pretty simple and the Docker team tries to keep it intact between Docker engine releases.</p>
<p>The core principle is very simple: <code>1 Dockerfile -&gt; 1 Docker Image</code>.</p>
<p>This principle works just fine for basic use cases, where you just need to demonstrate Docker capabilities or put some &quot;static&quot; content into a Docker image.</p>
<p>Once you advance with Docker and would like to create secure and lean Docker images, singe <code>Dockerfile</code> is not enough.</p>
<p>People who insist on following the above principle find themselves with slow Docker builds, huge Docker images (several GB size images), slow deployment time and lots of CVE violations embedded into these images.</p>
<h2 id="the-docker-build-container-pattern">The Docker Build Container pattern</h2>
<p><a href="https://medium.com/@alexeiled/docker-pattern-the-build-container-b0d0e86ad601">Docker Pattern: The Build Container</a></p>
<p>The basic idea behind <strong>Build Container</strong> pattern is simple:</p>
<blockquote>
<p>Create additional Docker images with required tools (compilers, linters, testing tools) and use these images to produce lean, secure and production ready Docker image.</p>
</blockquote>
<p>=============</p>
<p>An example of the <strong>Build Container</strong> pattern for typical Node.js application:</p>
<ol>
<li>Derive <code>FROM</code> a Node base image (for example <code>node:6.10-alpine</code>) <code>node</code> and <code>npm</code> installed (<code>Dockerfile.build</code>)</li>
<li>Add <code>package.json</code></li>
<li>Install all node modules from <code>dependency</code> and <code>devDependency</code></li>
<li>Copy application code</li>
<li>Run compilers, code coverage, linters, code analysis and testing tools</li>
<li>Create the <strong>production</strong> Docker image; derive <code>FROM</code> same or other Node base image</li>
<li>install node modules required for runtime (<code>npm install --only=production</code>)</li>
<li>expose <code>PORT</code> and define default <code>CMD</code> (command to run your application)</li>
<li>Push the <strong>production</strong> image to some Docker registry</li>
</ol>
<p>This flow assumes that you are using two or more separate <code>Dockerfile</code>s and a shell script or flow tool to orchestrate all steps above.</p>
<h3 id="example">Example</h3>
<p>I use a fork of <a href="https://github.com/sdelements/lets-chat">Let's Chat</a> node.js application.</p>
<h4 id="builder-docker-image-with-eslint-mocha-and-gulp">Builder Docker image with eslint, mocha and gulp</h4>
<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> alpine:3.5</span>
<span class="c"># install node </span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> nodejs
<span class="c"># set working directory</span>
<span class="k">WORKDIR</span><span class="s"> /root/chat</span>
<span class="c"># copy project file</span>
<span class="k">COPY</span><span class="s"> package.json .</span>
<span class="c"># install node packages</span>
<span class="k">RUN </span>npm <span class="nb">set </span><span class="nv">progress</span><span class="o">=</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    npm config <span class="nb">set </span>depth 0 <span class="o">&amp;&amp;</span> <span class="se">\
</span>    npm <span class="nb">install</span>
<span class="c"># copy app files</span>
<span class="k">COPY</span><span class="s"> . .</span>
<span class="c"># run linter, setup and tests</span>
<span class="k">CMD</span><span class="s"> npm run lint &amp;&amp; npm run setup &amp;&amp; npm run test</span>
</code></pre></div></div>
<h4 id="production-docker-image-with-production-node-modules-only">Production Docker image with 'production' node modules only</h4>
<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> alpine:3.5</span>
<span class="c"># install node</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> nodejs tini
<span class="c"># set working directory</span>
<span class="k">WORKDIR</span><span class="s"> /root/chat</span>
<span class="c"># copy project file</span>
<span class="k">COPY</span><span class="s"> package.json .</span>
<span class="c"># install node packages</span>
<span class="k">RUN </span>npm <span class="nb">set </span><span class="nv">progress</span><span class="o">=</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    npm config <span class="nb">set </span>depth 0 <span class="o">&amp;&amp;</span> <span class="se">\
</span>    npm <span class="nb">install</span> <span class="nt">--only</span><span class="o">=</span>production <span class="o">&amp;&amp;</span> <span class="se">\
</span>    npm cache clean
<span class="c"># copy app files</span>
<span class="k">COPY</span><span class="s"> . .</span>
<span class="c"># Set tini as entrypoint</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["/sbin/tini", "--"]</span>
<span class="c"># application server port</span>
<span class="k">EXPOSE</span><span class="s"> 5000</span>
<span class="c"># default run command</span>
<span class="k">CMD</span><span class="s"> npm run start</span>
</code></pre></div></div>
<h2 id="what-is-docker-multi-stage-build">What is Docker multi-stage build?</h2>
<p>Docker 17.0.5 extends <code>Dockerfile</code> syntax to support new <strong>multi-stage</strong> build, by extending two commands: <code>FROM</code> and <code>COPY</code>.</p>
<p>The <strong>multi-stage</strong> build allows using multiple <code>FROM</code> commands in the same Dockerfile. The last <code>FROM</code> command produces the final Docker image, all other images are intermediate images (no final Docker image is produced, but <em>all layers are cached</em>).</p>
<p>The <code>FROM</code> syntax also supports <code>AS</code> keyword. Use <code>AS</code> keyword to give the current image a logical name and reference to it later by this name.</p>
<p>To copy files from intermediate images use <code>COPY --from=&lt;image_AS_name|image_number&gt;</code>, where number starts from <code>0</code> (but better to use logical name through <code>AS</code> keyword).</p>
<h2 id="creating-a-multi-stage-dockerfile-for-nodejs-application">Creating a multi-stage Dockerfile for Node.js application</h2>
<p>The <code>Dockerfile</code> below makes the <strong>Build Container</strong> pattern obsolete, allowing to achieve the same result with the single file.</p>
<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="c"># ---- Base Node ----</span>
<span class="k">FROM</span><span class="s"> alpine:3.5 AS base</span>
<span class="c"># install node</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> nodejs-npm tini
<span class="c"># set working directory</span>
<span class="k">WORKDIR</span><span class="s"> /root/chat</span>
<span class="c"># Set tini as entrypoint</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["/sbin/tini", "--"]</span>
<span class="c"># copy project file</span>
<span class="k">COPY</span><span class="s"> package.json .</span>

<span class="c">#</span>
<span class="c"># ---- Dependencies ----</span>
<span class="k">FROM</span><span class="s"> base AS dependencies</span>
<span class="c"># install node packages</span>
<span class="k">RUN </span>npm <span class="nb">set </span><span class="nv">progress</span><span class="o">=</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> npm config <span class="nb">set </span>depth 0
<span class="k">RUN </span>npm <span class="nb">install</span> <span class="nt">--only</span><span class="o">=</span>production 
<span class="c"># copy production node_modules aside</span>
<span class="k">RUN </span><span class="nb">cp</span> <span class="nt">-R</span> node_modules prod_node_modules
<span class="c"># install ALL node_modules, including 'devDependencies'</span>
<span class="k">RUN </span>npm <span class="nb">install</span>

<span class="c">#</span>
<span class="c"># ---- Test ----</span>
<span class="c"># run linters, setup and tests</span>
<span class="k">FROM</span><span class="s"> dependencies AS test</span>
<span class="k">COPY</span><span class="s"> . .</span>
<span class="k">RUN  </span>npm run lint <span class="o">&amp;&amp;</span> npm run setup <span class="o">&amp;&amp;</span> npm run <span class="nb">test</span>

<span class="c">#</span>
<span class="c"># ---- Release ----</span>
<span class="k">FROM</span><span class="s"> base AS release</span>
<span class="c"># copy production node_modules</span>
<span class="k">COPY</span><span class="s"> --from=dependencies /root/chat/prod_node_modules ./node_modules</span>
<span class="c"># copy app sources</span>
<span class="k">COPY</span><span class="s"> . .</span>
<span class="c"># expose port and define CMD</span>
<span class="k">EXPOSE</span><span class="s"> 5000</span>
<span class="k">CMD</span><span class="s"> npm run start</span>
</code></pre></div></div>
<p>The above <code>Dockerfile</code> creates 3 intermediate Docker images and single <strong>release</strong> Docker image (the final <code>FROM</code>).</p>
<ol>
<li>First image <code>FROM alpine:3.5 AS bas</code> - is a base Node image with: <code>node</code>, <code>npm</code>, <code>tini</code> (init app) and <code>package.json</code></li>
<li>Second image <code>FROM base AS dependencies</code> - contains all node modules from <code>dependencies</code> and <code>devDependencies</code> with additional copy of <code>dependencies</code> required for final image only</li>
<li>Third image <code>FROM dependencies AS test</code> - runs linters, setup and tests (with <code>mocha</code>); if this run command fail not final image is produced</li>
<li>The final image <code>FROM base AS release</code> - is a base Node image with application code and all node modules from <code>dependencies</code></li>
</ol>
<h2 id="try-docker-multi-stage-build-today">Try Docker multi-stage build today</h2>
<p>In order to try Docker <strong>multi-stage</strong> build, you need to get Docker 17.0.5, which is going to be released in May and currently available on the <em>beta</em> channel.</p>
<p>So, you have two options:</p>
<ol>
<li>Use <em>beta</em> channel to get Docker 17.0.5</li>
<li>Run <em>dind</em> container (docker-in-docker)</li>
</ol>
<h3 id="running-docker-in-docker-1705-beta">Running Docker-in-Docker 17.0.5 (beta)</h3>
<p>Running Docker 17.0.5 (beta) in docker container (<code>--privileged</code> is required):</p>
<pre><code>$ docker run -d --rm --privileged -p 23751:2375 --name dind docker:17.05.0-ce-dind --storage-driver overlay2
</code></pre>
<p>Try <strong>mult-stage</strong> build. Add <code>--host=:23751</code> to every Docker command, or set <code>DOCKER_HOST</code> environment variable.</p>
<pre><code>$ # using --host
$ docker --host=:23751 build -t local/chat:multi-stage .

$ # OR: setting DOCKER_HOST
$ export DOCKER_HOST=localhost:23751
$ docker build -t local/chat:multi-stage .
</code></pre>
<h2 id="summary">Summary</h2>
<p>With Docker <strong>multi-stage</strong> build feature, it's possible to implement an advanced Docker image build pipeline using a single <code>Dockerfile</code>. Kudos to Docker team!</p>
<hr />
<p>Hope, you find this post useful. I look forward to your comments and any questions you have.</p>

  </div><a class="u-url" href="/docker/2017/04/25/node-docker-multistage.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Alexei Lednev</li><li><a class="u-email" href="mailto:alexei.led@gmail.com">alexei.led@gmail.com</a></li></ul>
      </div>

      <div class="footer-col">
        <p>Alexei Lednev&#39;s personal blog</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
      <a href="https://github.com/alexei-led" title="GitHub">
        <svg class="svg-icon grey">
          <use xlink:href="/assets/minima-social-icons.svg#github"></use>
        </svg>
        <span class="username">Github</span>
      </a>
    </li></ul></div>
  </div>
</footer></body>

</html>
